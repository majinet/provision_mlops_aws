name: Provisioning Flyte Pre-requisites

on:
  workflow_dispatch:
    inputs:
      region:
        description: 'AWS Region'
        required: true
        default: 'us-east-1'
      #keypair:
      #  description: 'SSH Key Pair'
      #  required: true

env:
  AWS_REGION : ${{ github.event.inputs.region}} #Change to reflect your Region

# Permission can be added at job level or workflow level
permissions:
      id-token: write   # This is required for requesting the JWT
      contents: read    # This is required for actions/checkout

jobs:
  eks_aws:
    name: Provisioning AWS EKS
    runs-on: ubuntu-latest
    outputs:
      env-name: ${{ steps.env-name.outputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: configure aws credentials
        uses: aws-actions/configure-aws-credentials@v1.7.0
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubAction-AssumeRoleWithAction #change to reflect your IAM roleâ€™s ARN
          role-session-name: GitHub_to_AWS_via_FederatedOIDC
          aws-region: ${{ env.AWS_REGION }}
      - name: install envsubst
        id: install-envsubst
        run: |
          curl -L https://github.com/a8m/envsubst/releases/download/v1.2.0/envsubst-`uname -s`-`uname -m` -o envsubst
          chmod +x envsubst
          sudo mv envsubst /usr/local/bin
      - name: Check if IAM Cluster role exists
        id: check-cluster-role
        run: |
          aws iam get-role --role-name eksClusterRole > /dev/null 2>&1 || echo "::set-output name=role_exists::false"
      - name: Create IAM role for Cluster
        id: create-iam-role-for-cluster
        if: steps.check-cluster-role.outputs.role_exists == 'false'
        run: |
          aws iam create-role \
            --role-name eksClusterRole \
            --assume-role-policy-document file://"config/cluster-trust-policy.json"
          
          aws iam attach-role-policy \
            --policy-arn arn:aws:iam::aws:policy/AmazonEKSClusterPolicy \
            --role-name eksClusterRole
      - name: Check if EKS Node IAM role exists
        id: check-node-role
        run: |
          aws iam get-role --role-name AmazonEKSNodeRole > /dev/null 2>&1 || echo "::set-output name=role_exists::false"
      - name: Create IAM role for Node
        id: create-iam-role-for-node
        if: steps.check-node-role.outputs.role_exists == 'false'
        run: |
          aws iam create-role \
            --role-name AmazonEKSNodeRole \
            --assume-role-policy-document file://"config/node-role-trust-relationship.json"

          aws iam attach-role-policy \
            --policy-arn arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy \
            --role-name AmazonEKSNodeRole
          
          aws iam attach-role-policy \
            --policy-arn arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly \
            --role-name AmazonEKSNodeRole
      - name: Get ARN of ODIC provider
        id: get-oidc-provider-arn
        run: |
          OIDC_PROVIDER_NAME=$(aws iam list-open-id-connect-providers --query 'OpenIDConnectProviderList[?contains(Arn, `oidc.eks.us-east-1.amazonaws.com`)].Arn' --output text)

          OIDC_PROVIDER_ARN=$(aws iam list-open-id-connect-providers --query 'OpenIDConnectProviderList[?Arn==`arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:oidc-provider/$OIDC_PROVIDER_NAME`].Arn' --output text)
          echo "OIDC_PROVIDER_ARN: $OIDC_PROVIDER_ARN"
          echo "OIDC_PROVIDER_ARN=$OIDC_PROVIDER_ARN" >> $GITHUB_ENV
      - name: Trust between ODIC and Flyte
        id: trust-between-oidc-and-flyte
        run: |
      - name: Check if Flyte system IAM role exists
        id: check-flyte-system-role
        run: |
          aws iam get-role --role-name FlyteSystemRole > /dev/null 2>&1 || echo "::set-output name=role_exists::false"
      - name: Create IAM role for Flyte system
        id: create-iam-role-for-flyte-system
        if: steps.check-flyte-system-role.outputs.role_exists == 'false'
        run: |
          cat config/odic-flyte-trust-policy.json | envsubst > odic-flyte-trust-policy.json
          cat odic-flyte-trust-policy.json
          
          aws iam create-role \
            --role-name iam-role-flyte \
            --assume-role-policy-document file://"odic-flyte-trust-policy.json"

          aws iam attach-role-policy \
            --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess \
            --role-name iam-role-flyte
      - name: Check if Flyte user IAM role exists
        id: check-flyte-user-role
        run: |
          aws iam get-role --role-name FlyteUserRole > /dev/null 2>&1 || echo "::set-output name=role_exists::false"
      - name: Create IAM role for Flyte user
        id: create-iam-role-for-flyte-user
        if: steps.check-flyte-user-role.outputs.role_exists == 'false'
        run: |
          aws iam create-role \
            --role-name flyte-user-role \
            --assume-role-policy-document file://"odic-flyte-trust-policy.json"

          aws iam attach-role-policy \
            --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess \
            --role-name flyte-user-role
      - name: Set VPC ID
        id: set-vpc-id
        run: |
          VPC_ID=$(aws cloudformation describe-stacks --stack-name eksctl-eks-cluster-cluster --query 'Stacks[0].Outputs[?OutputKey==`VPC`].OutputValue' --output text)
          echo "VPC ID: $VPC_ID"
          echo "VPC_ID=$VPC_ID" >> $GITHUB_ENV
